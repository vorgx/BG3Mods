Listview.funcBox.coFlagUpOfDate=function(e){const t=e.commentCell.find(".comment-notification");if(!(e.user===g_user.name||WH.User.hasCapability(WH.User.CAP_OUT_OF_DATE_COMMENTS))){return}if(confirm("Mark comment "+e.id+" as up to date?")){e.container.removeClass("comment-outofdate");WH.fetch(WH.Url.generatePath("/comment/out-of-date"),{json:{_csrf:WH.User.getSessionKey(),commentId:e.id,outOfDate:false},success:function(e){MessageBox(t,WH.TERMS.uptodateresponse)},error:function(e){MessageBox(t,"Error: "+e.error)}})}};Listview.funcBox.coFlagOutOfDate=function(e){const t=e.commentCell.find(".comment-notification");if(e.user===g_user.name||WH.User.hasCapability(WH.User.CAP_OUT_OF_DATE_COMMENTS)){if(confirm("Mark comment "+e.id+" as out of date?")){e.container.addClass("comment-outofdate");WH.fetch(WH.Url.generatePath("/comment/out-of-date"),{json:{_csrf:WH.User.getSessionKey(),commentId:e.id,outOfDate:true},success:function(e){MessageBox(t,WH.TERMS.outofdateresponse)},error:function(e){MessageBox(t,"Error: "+e.error)}})}return}let a=null;while(true){a=prompt(WH.TERMS.outofdate_tip);if(a===null){return}else if(a.toString().length>0){break}alert(WH.TERMS.youmustprovideareason_stc)}WH.fetch(WH.Url.generatePath("/comment/out-of-date-report"),{json:{_csrf:WH.User.getSessionKey(),commentId:e.id,reason:a},success:function(e){MessageBox(t,WH.TERMS.outofdateresponsequeued)},error:function(e){MessageBox(t,"Error: "+e.error)}})};Listview.funcBox.coDelete=function(e){var t=e.user==g_user.name||(g_user.roles&(U_GROUP_ADMIN|U_GROUP_MOD|U_GROUP_BUREAU))!=0;var a=e.commentCell.find(".comment-notification");if(t){if(!confirm(WH.TERMS.deletecomment_tip)){return}$.post(WH.Url.generatePath("/comment/delete"),{id:e.id});if(!e.commentv2){this.deleteRows([e]);return}e.container.addClass("comment-deleted");MessageBox(a,WH.TERMS.commentdeleted_tip);e.deletedInfo=[WH.getServerTime(),g_user.name];e.deleted=true;Listview.templates.comment.updateCommentCell.call(this,e);WH.Tooltips.hide();return}};Listview.funcBox.coUndelete=function(e){var t=e.user==g_user.name||(g_user.roles&(U_GROUP_ADMIN|U_GROUP_MOD))!=0;var a=e.commentCell.find(".comment-notification");if(confirm(WH.TERMS.votetoundelete_tip)){$.post(WH.Url.generatePath("/comment/undelete"),{id:e.id});if(t){MessageBox(a,"This comment has been restored.");if(e.commentv2){e.container.removeClass("comment-deleted");e.deletedInfo=null;e.deleted=false;Listview.templates.comment.updateCommentCell.call(this,e);WH.Tooltips.hide()}}else{MessageBox(a,WH.TERMS.votedtodelete_tip)}}};Listview.funcBox.coSortNewestFirst=function(e){WH.setCookie("comments_sort",1e3,"1","/",".wowhead.com");$(e).parent().find("a.selected").removeClass("selected");e.className="selected";this.mainDiv.className+=" listview-aci";this.setSort([-5,4,6,-7,-1,-2],true,false)};Listview.funcBox.coSortOldestFirst=function(e){WH.setCookie("comments_sort",1e3,"2","/",".wowhead.com");$(e).parent().find("a.selected").removeClass("selected");e.className="selected";this.mainDiv.className+=" listview-aci";this.setSort([-5,4,6,7,1,2],true,false)};Listview.funcBox.coSortHighestRatedFirst=function(e){WH.setCookie("comments_sort",1e3,"3","/",".wowhead.com");$(e).parent().find("a.selected").removeClass("selected");e.className="selected";this.mainDiv.className=this.mainDiv.className.replace("listview-aci","");this.setSort([-5,4,6,-3,7],true,false)};Listview.funcBox.coFilterByPatchVersion=function(e){this.minPatchVersion=e.value;this.refreshRows()};Listview.templates.comment={copyableColumns:false,sort:[-5,4,6,-3,7],mode:Listview.MODE_DIV,nItemsPerPage:40,hash:Listview.HASH_SIMPLE,alternateVersions:undefined,columns:[{value:"number"},{value:"id"},{value:"rating"},{value:"deleted"},{value:"sticky"},{value:"outofdate"},{value:"date",sortFunc:function(e,t){try{return Math.sign(Date.parse(e.date)-Date.parse(t.date))}catch(a){return(e.date||"").localeCompare(t.date||"")}}}],compute:function(e,t,a){var s=$("<div></div>");var o=!this.alternateVersions&&e.__minPatch&&(e.__minPatch.substr(0,1)!="-"&&e.__minPatch>new Date(e.date)||e.__minPatch.substr(0,1)=="-"&&e.__minPatch!="-"+e.dataTree);e.locale=this.id=="english-comments"?LOCALE_ENUS:Locale.getId();s.append('<table><tr><td class="vote-column">'+'<p class="upvote"><span class="fa fa-chevron-up"></span></p><div class="rating-container"></div><p class="downvote"><span class="fa fa-chevron-down"></span></p><p class="comment-sticky" title="'+WH.TERMS.stickycomment_tip+'">STICKY</p>'+'</td><td class="comment-content-column">'+'<div class="comment-header"><table><tr><td class="comment-author"></td><td class="comment-controls"></td><td class="comment-notification"></td></tr></table></div>'+'<div class="text comment-body" lang="'+Locale.getCode(e.locale)+'"></div>'+'<div class="comment-replies"></div>'+'<p class="comment-replies-control" style="display: none"></p>'+"</td></tr></table>");e.colorClass="comment"+a%2;s.addClass("comment").addClass(e.colorClass);if(e.rating<WH.Comments.LOW_RATING_THRESHOLD){s.addClass("comment-very-low-rating")}if(e.deleted){s.addClass("comment-deleted")}if(e.outofdate){s.addClass("comment-outofdate")}e.container=s;e.voteCell=s.find(".vote-column");e.commentCell=s.find(".comment-content-column");e.repliesCell=s.find(".comment-replies");e.repliesControl=s.find(".comment-replies-control");e.headerCell=s.find(".comment-header");e.commentBody=s.find(".comment-body");e.commentAuthor=s.find(".comment-author");e.commentControls=s.find(".comment-controls");this.template.updateVoteCell.call(this,e);this.template.updateCommentCell.call(this,e);this.template.updateStickyStatus.call(this,e);this.template.updateReplies.call(this,e);if(e.deleted||e.rating<WH.Comments.LOW_RATING_THRESHOLD){e.headerCell.bind("click",(function(){e.container.toggleClass("comment-expanded")}))}var n=$(t);n.addClass("comment-wrapper").html(s);if(e.imported){var r=WH.ce("span",{className:"comment-author-source-imported",dataset:{importedSite:e.user}});var i=WH.ce("span",{className:"comment-author-source-imported-title"},WH.ct(e.user));r.innerHTML=WH.TERMS.fromSite_format.replace("%s",i.outerHTML);e.commentAuthor.prepend(r);t.classList.add("comment-wrapper-imported")}if(o){n.hide()}else{n.show()}},applyAuthorTitle:function(e,t){if(!t.label){return}let a=["comment-reply-author-label"].concat(t.classes);WH.ae(e,WH.ct(WH.TERMS.wordspace_punct));if(t.url){WH.ae(e,WH.ce("a",{className:a.join(" "),href:t.url},WH.ct(`<${t.label}>`)))}else{WH.ae(e,WH.ce("span",{className:a.join(" ")},WH.ct(`<${t.label}>`)))}},getAuthorTitle:function(e){let t={classes:[],label:undefined,url:undefined};if(WH.getPageData("guide.author")===e){t.label=WH.TERMS.guideAuthor;return t}let a=g_users[e];if(a){let s=WH.User.getCommentTitleClass(a.roles,a.tierClass,e);if(s){t.classes.push(s)}t.label=WH.User.getCommentRoleLabel(a.roles,a.title,a.tierTitle);t.url=a.tierTitle&&!a.title?WH.Url.generatePath("/premium"):""}return t},updateReplies:function(e){this.template.updateRepliesCell.call(this,e);this.template.updateRepliesControl.call(this,e);WH.CommentReplies.setupReplies(e.container,e,this);if(!e.alreadyLoadedBefore){e.alreadyLoadedBefore=true;var t=location.hash.match("#comments:id=([0-9]+):reply=([0-9]+)");if(t){var a=t[1];var s=t[2];if(e.id==a){this.template.highlightReply.call(this,e,s)}}}},highlightReply:function(e,t,a){t=parseInt(t);let s=e.replies.find((e=>e.id===t));if(!s){if(a){return}$.ajax({type:"GET",url:WH.Url.generatePath("/comment/show-replies"),data:{id:e.id},success:function(a){e.replies=a;Listview.templates.comment.updateReplies(e);Listview.templates.comment.highlightReply(e,t,true)},dataType:"json"});return}let o=WH.qs(`.comment-reply-row[data-replyid="${t}"]`,e.repliesCell[0]);if(!o){return}let n="comment-reply-row-highlight";if(e.deleted){n+="-deleted"}else if(e.outofdate){n+="-out-of-date"}o.classList.add(n)},updateStickyStatus:function(e){if(e.sticky){e.voteCell.find(".comment-sticky").show()}else{e.voteCell.find(".comment-sticky").hide()}},updateRepliesCell:function(e){var t=e.repliesCell;var a=$("<table></table>");t.html("");if(!e.replies.length){t.append(a).hide();return}for(var s=0;s<e.replies.length;++s){var o=e.replies[s];let t=WH.getPageData("guide.author")===o.username;var n=$('<tr class="comment-reply-row"><td class="reply-controls"><p class="reply-upvote"><span class="fa fa-chevron-up"></span></p><p class="reply-rating"></p><p class="reply-downvote"><span class="fa fa-chevron-down"></span></p></td><td class="reply-text"></td></tr>');var r=$('<p class="comment-reply-author"></p>');var i=$("<a></a>");let h=WH.ce("div",{className:"comment-reply-body"});h.setAttribute("lang",Locale.getCode(e.locale));var l=new Date(o.creationdate);var c=(WH.getServerTime()-l)/1e3;var m=n.find(".reply-upvote");var d=n.find(".reply-downvote");var p=g_user.name==o.username||(g_user.roles&U_GROUP_COMMENTS_MODERATOR)!=0;var u=p;if(o.deleted){n.addClass("comment-reply-row-deleted");n.bind("click",(function(){this.classList.remove("comment-reply-row-deleted")}))}else if(o.rating<WH.Comments.LOW_RATING_THRESHOLD){n.addClass("comment-reply-row-very-low-rating");n.bind("click",(function(){this.classList.remove("comment-reply-row-very-low-rating")}))}n.attr("data-replyid",o.id);n.attr("data-idx",s);let H=WH.User.getCommentRoleClass(o.roles,o.username);if(!["comment-role-admin","comment-role-moderator"].includes(H)&&t){H="comment-guide-author"}n.find(".reply-text").addClass(H);var f=$("<a></a>");f.text(WH.formatDate(null,c,l));f.attr("href","#comments:id="+e.id+":reply="+o.id);f.attr("id","comments:id="+e.id+":reply="+o.id);f.addClass("when");if(!o.imported){i.attr("href","/user="+o.username);i.text(o.username);r.append(i);this.template.applyAuthorTitle(r[0],this.template.getAuthorTitle(o.username))}else{n.addClass("reply-imported");n.get(0).dataset.importedSite=o.username;r.append(WH.ct(o.importedAuthor))}r.append(" ").append(f).append(" ");if(o.dataTree==WH.dataTree.RETAIL||o.imported){r.append(WH.sprintf(WH.TERMS.patchparens_format,WH.Wow.getVersionStringFromTimestamp(l,this.alternateVersions)))}else{r.append(WH.TERMS.openparenthesis_punct+WH.TERMS[WH.getDataTreeTerm(o.dataTree)]+WH.TERMS.closedparenthesis_punct)}WH.Comments.appendImportedSubject(r,o.importedSubject);WH.ae(h,WH.markup.getDomFragment(o.body,{allow:t?WH.markup.rolesToClass(o.roles):WH.markup.CLASS.USER,mode:t?WH.markup.MODE.COMMENT:WH.markup.MODE.REPLY,roles:0,locale:e.locale,disabledEnvironments:o.markupDisabledEnvironments}));const W=WH.ae(h,WH.ce("div",{className:"wh-button-group"}));if(g_user.canUpvote&&g_user.name!==o.username&&!o.reportedByUser){const e=new WH.Button({"data-simple-tooltip":WH.TERMS.reportthisreply_stc,"data-variation":WH.getDataTreeKey(),iconConfig:{faIcon:{prefix:"fas",name:"triangle-exclamation"}},id:"comment-reply-report",size:"small",style:"transparent"});WH.ae(W,e.getElement())}if(u){const e=new WH.Button({"data-simple-tooltip":WH.TERMS.editthisreply_stc,"data-variation":WH.getDataTreeKey(),iconConfig:{faIcon:{prefix:"fas",name:"pencil"}},id:"comment-reply-edit",size:"small",style:"transparent"});WH.ae(W,e.getElement())}if(p){const e=new WH.Button({"data-simple-tooltip":WH.TERMS.deletethisreply_stc,"data-variation":WH.getDataTreeKey(),iconConfig:{faIcon:{prefix:"fas",name:"trash-xmark"}},id:"comment-reply-delete",size:"small",style:"transparent"});WH.ae(W,e.getElement())}n.find(".reply-text").append(r).append(h);n.find(".reply-rating").text(o.rating);if(o.votedByUser){m.attr("data-hasvoted","true")}if(g_user.canUpvote&&g_user.name!=o.username&&!o.votedByUser&&!o.downvotedByUser){m.attr("data-canvote","true")}if(o.downvotedByUser){d.attr("data-hasvoted","true")}if(g_user.canDownvote&&g_user.name!=o.username&&!o.votedByUser&&!o.downvotedByUser){d.attr("data-canvote","true")}a.append(n)}t.html(a)},updateRepliesControl:function(e){let t=e.repliesControl;t.html("").hide().unbind().attr("class","comment-replies-control");let a=Math.max(e.nreplies-e.replies.length,0);let s=g_user.canPostReplies&&this.template.commentingAvailable();if(e.deleted||e.outofdate||e.rating<WH.Comments.LOW_RATING_THRESHOLD||!s&&!a){return}if(s){if(!a){t.text(WH.TERMS.addreply_stc).addClass("add-reply")}else{t.text(WH.sprintf(a===1?WH.TERMS.addshow1morereply_stc:WH.TERMS.addshowmorereplies_format,a)).addClass("show-more-replies")}}else{t.text(WH.sprintf(a===1?WH.TERMS.show1morereply_stc:WH.TERMS.showmorereplies_format,a)).addClass("show-more-replies")}t.addClass("btn btn-small").show()},updateCommentCell:function(e){e.commentCell.find(".comment-edit").remove();this.template.updateCommentBody.call(this,e,e.commentBody);this.template.updateCommentAuthor.call(this,e,e.commentAuthor);this.template.updateCommentControls.call(this,e,e.commentControls)},updateCommentAuthor:function(e,t){let a=g_users[e.user];let s=new Date(e.date);let o=(WH.getServerTime()-s)/1e3;t.html("");t.append(WH.TERMS.by);if(!e.imported){let s=WH.Strings.escapeHtml(WH.Url.generatePath("/user="+e.user));t.append(WH.sprintf('<a href="'+s+'">$1</a>',WH.Strings.escapeHtml(e.user)));if(a){t.append(WH.getReputationPlusAchievementText(a.gold,a.silver,a.copper,a.reputation))}this.template.applyAuthorTitle(t[0],this.template.getAuthorTitle(e.user))}else{t.append(WH.ct(e.importedAuthor))}t.append(WH.sprintf(' <a class="q0" id="comments:id=$1" href="#comments:id=$2">$3</a>',e.id,e.id,WH.formatDate(null,o,s)));if(e.dataTree==WH.dataTree.RETAIL||e.imported){t.append(WH.sprintf(WH.TERMS.patchparens_format,WH.Wow.getVersionStringFromTimestamp(s,this.alternateVersions)))}else{t.append(" "+WH.TERMS.openparenthesis_punct+WH.TERMS[WH.getDataTreeTerm(e.dataTree)]+WH.TERMS.closedparenthesis_punct)}WH.Comments.appendImportedSubject(t,e.importedSubject)},updateCommentControls:function(e,t){var a=(g_user.roles&U_GROUP_COMMENTS_MODERATOR)!=0||e.user.toLowerCase()==g_user.name.toLowerCase()&&!g_user.commentban;var s=(g_user.roles&U_GROUP_COMMENTS_MODERATOR)!=0||e.user.toLowerCase()==g_user.name.toLowerCase()&&!g_user.commentban;var o=(g_user.roles&U_GROUP_COMMENTS_MODERATOR)!=0;t.html("");const n=WH.ce("div",{className:"wh-button-group",dataset:{alignment:"end"}});t.append(n);if(a&&!e.outofdate&&!e.deleted){const t=new WH.Button({"data-variation":WH.getDataTreeKey(),clickHandler:WH.Comments.edit.bind(this,e,WH.Comments.EDIT_MODE_EDIT_COMMENT,false),iconConfig:{faIcon:{prefix:"fas",name:"pencil"}},size:"small",style:"transparent"}).getElement();WH.ae(n,t);WH.Tooltips.attach(t,WH.TERMS.edit)}if(s&&!e.deleted){const t=new WH.Button({"data-variation":WH.getDataTreeKey(),clickHandler:Listview.funcBox.coDelete.bind(this,e),iconConfig:{faIcon:{prefix:"fas",name:"trash-xmark"}},size:"small",style:"transparent"}).getElement();WH.ae(n,t);WH.Tooltips.attach(t,WH.TERMS.delete)}if(o&&e.deleted){const t=new WH.Button({"data-variation":WH.getDataTreeKey(),clickHandler:Listview.funcBox.coUndelete.bind(this,e),iconConfig:{faIcon:{prefix:"fas",name:"trash-undo"}},size:"small",style:"transparent"}).getElement();WH.ae(n,t);WH.Tooltips.attach(t,WH.TERMS.undelete)}if(WH.isRetailTree()){if(o&&e.outofdate){const t=new WH.Button({"data-variation":WH.getDataTreeKey(),clickHandler:Listview.funcBox.coFlagUpOfDate.bind(this,e),iconConfig:{faIcon:{prefix:"fas",name:"clock"}},size:"small",style:"transparent"}).getElement();WH.ae(n,t);WH.Tooltips.attach(t,WH.TERMS.uptodate)}if(g_user.id!=0&&!e.outofdate&&!e.deleted){const t=new WH.Button({"data-variation":WH.getDataTreeKey(),clickHandler:Listview.funcBox.coFlagOutOfDate.bind(this,e),iconConfig:{faIcon:{prefix:"fas",name:"clock"}},size:"small",style:"transparent"}).getElement();WH.ae(n,t);WH.Tooltips.attach(t,WH.TERMS.outofdate)}}if(o&&!e.sticky&&!e.outofdate&&!e.deleted){const t=new WH.Button({"data-variation":WH.getDataTreeKey(),clickHandler:this.template.sticky.bind(this,e),iconConfig:{faIcon:{prefix:"fas",name:"thumbtack"}},size:"small",style:"transparent"}).getElement();WH.ae(n,t);WH.Tooltips.attach(t,WH.TERMS.makeStickyComment_tip)}if(o&&e.sticky&&!e.outofdate&&!e.deleted){const t=new WH.Button({clickHandler:this.template.sticky.bind(this,e),"data-variation":WH.getDataTreeKey(),iconConfig:{faIcon:{prefix:"fas",name:"thumbtack"}},style:"transparent",size:"small"}).getElement();WH.ae(n,t);WH.Tooltips.attach(t,WH.TERMS.stickycomment_tip)}if(!e.outofdate&&!e.deleted){const t=new WH.Button({"data-variation":WH.getDataTreeKey(),clickHandler:ContactTool.show.bind(ContactTool,{mode:1,comment:e}),iconConfig:{faIcon:{prefix:"fas",name:"triangle-exclamation"}},size:"small",style:"transparent"}).getElement();WH.ae(n,t);WH.Tooltips.attach(t,WH.TERMS.reportingoptions_tip)}},updateCommentBody:function(e,t){let a=WH.getPageData("guide.author")===e.user;var s=WH.markup.rolesToClass(e.roles);t.empty();WH.Comments.appendImportedSubject(t,e.importedSubject);t.removeClass("comment-high-rating");t.addClass(WH.Comments.getColorClass(e,undefined,undefined,a));t.append(WH.markup.getDomFragment(e.body,{allow:s,mode:WH.markup.MODE.COMMENT,roles:e.roles,locale:e.locale,disabledEnvironments:e.markupDisabledEnvironments}));if(e.response){var o=$("<div></div>");o.addClass("text comment-body");o.empty().append(WH.markup.getDomFragment("[div][/div][wowheadresponse="+e.responseuser+" roles="+e.responseroles+"]"+e.response+"[/wowheadresponse]",{allow:WH.markup.CLASS.STAFF,roles:e.responseroles,uid:"resp-"+e.id,disabledEnvironments:e.markupDisabledEnvironments}));t.append(o)}if(e.lastEdit){this.template.addEditedByOrDeletedByText.call(this,t,WH.TERMS.lasteditedby_stc,e.lastEdit[2],e.lastEdit[0],e.dataTree)}if(e.deletedInfo){this.template.addEditedByOrDeletedByText.call(this,t,WH.TERMS.deletedby_stc,e.deletedInfo[1],e.deletedInfo[0],e.dataTree)}e.divBody=t[0]},addEditedByOrDeletedByText:function(e,t,a,s,o){var n=new Date(s);var r=(WH.getServerTime()-n)/1e3;var i=$("<div></div>");i.addClass("comment-lastedit");i.html(WH.sprintf("$1 <a></a> $2"+(o===WH.dataTree.RETAIL?" $3":""),t,WH.formatDate(null,r,n),WH.sprintf(WH.TERMS.patchparens_format,WH.Wow.getVersionStringFromTimestamp(n,this.alternateVersions))));i.find("a").text(a).attr("href","/user="+a);e.append(i)},updateVoteCell:function(e){var t=e.voteCell.find(".upvote");var a=e.voteCell.find(".downvote");var s=e.voteCell.find(".rating-container");var o=$('<p class="rating"></p>');var n=this.template;s.html(o);let r=e.hasOwnProperty("termsOverride")?e.termsOverride:WH.TERMS;if(e.userRating>0){t.attr("data-hasvoted","true").attr("title",r.upvoted_tip)}else{t.attr("data-hasvoted","false").attr("title",r.upvote_tip)}if(e.userRating<0){a.attr("data-hasvoted","true").attr("title",r.downvoted_tip)}else{a.attr("data-hasvoted","false").attr("title",r.downvote_tip)}o.unbind();t.unbind();a.unbind();o.text(e.rating);o.click(function(){n.showVoteBreakdown.call(this,e,s)}.bind(this));t.click(function(){n.vote.call(this,e,1)}.bind(this));a.click(function(){n.vote.call(this,e,-1)}.bind(this))},vote:function(e,t){if(!t){return}let a=e.hasOwnProperty("termsOverride")?e.termsOverride:WH.TERMS;if(!g_user.id){let t=WH.term("voteLogin_format",'<a href="'+WH.Strings.escapeHtml(WH.Url.generatePath(WH.Url.getLoginPath()))+'">',"</a>",'<a href="'+WH.Strings.escapeHtml(WH.Url.generatePath(WH.Url.getRegistrationPath()))+'">',"</a>");this.template.voteError.call(this,e,t);return}if(e.deleted){this.template.voteError.call(this,e,a.votedeleted_tip);return}if(g_user.name==e.user){this.template.voteError.call(this,e,a.voteself_tip);return}if(!g_user.canUpvote&&t>0){let t=WH.term("upvoteNoRep_format",WH.ce("b",{},WH.ct(g_user.upvoteRep)).outerHTML,'<a href="'+WH.Strings.escapeHtml(WH.Url.generatePath("/reputation"))+'">',"</a>");this.template.voteError.call(this,e,t);return}if(!g_user.canDownvote&&t<0){let t=WH.term("downvoteNoRep_format",WH.ce("b",{},WH.ct(g_user.downvoteRep)).outerHTML,'<a href="'+WH.Strings.escapeHtml(WH.Url.generatePath("/reputation"))+'">',"</a>");this.template.voteError.call(this,e,t);return}if(t>0){t=g_user.superCommentVotes?2:1}else if(t<0){t=g_user.superCommentVotes?-2:-1}else{return}var s=e.rating;var o=e.userRating;var n=this.template;if(e.userRating>0&&t>0||e.userRating<0&&t<0){e.rating-=e.userRating;e.userRating=0}else{e.rating-=e.userRating;e.rating+=t;e.userRating=t}n.updateVoteCell.call(this,e);var r=function(t){if(t.error){e.rating=s;e.userRating=o;n.updateVoteCell.call(this,e)}if(t.message){n.voteError.call(this,e,t.message)}};var i=WH.Url.generatePath("/comment/vote");if(e.hasOwnProperty("voteUrl")){i=e.voteUrl}WH.fetch(WH.Url.generatePath(i),{json:{_csrf:WH.User.getSessionKey(),id:e.id,rating:t},success:r.bind(this)})},voteError:function(e,t){MessageBox(e.voteCell,t)},showVoteBreakdown:function(e,t){t.find("p").html('<img src="'+WH.staticUrl+'/images/icons/ajax.gif" />');let a=WH.Url.generatePath("/comment/rating");if(e.hasOwnProperty("ratingUrl")){a=e.ratingUrl}WH.fetch(WH.Url.generatePath(a+"?id="+e.id),{success:e=>{if(e.success){t.html(WH.sprintf('<p class="rating-up">$1</p><div class="rating-separator">'+'</div><p class="rating-down">$2</p>',e.up?"+"+e.up:0,-e.down))}else{MessageBox(t,"An error has occurred while fetching vote counts. Try refreshing the page.")}}})},sticky:function(e){const t=e.commentCell.find(".comment-notification");e.sticky=!e.sticky;const a=this;WH.fetch(WH.Url.generate("/comment/pinned"),{json:{_csrf:WH.User.getSessionKey(),commentId:e.id,pinned:e.sticky},success:function(){a.template.updateStickyStatus.call(a,e);a.template.updateCommentCell.call(a,e);if(e.sticky){MessageBox(t,"This comment is now pinned.")}else{MessageBox(t,"This comment is no longer pinned.")}}})},createNote:function(e){var t=WH.ce("small");if(!g_user.commentban&&this.template.commentingAvailable()){var a=WH.ce("a");if(g_user.id>0){a.href="javascript:";a.onclick=co_addYourComment}else{a.href=WH.Url.getLoginPath()}WH.ae(a,WH.ct(WH.TERMS.addyourcomment_stc));WH.ae(t,a);var s=WH.ce("span");s.style.padding="0 5px";s.style.color="white";WH.ae(s,WH.ct("|"));WH.ae(t,s)}WH.ae(t,WH.ct(WH.TERMS.sort+": "));var o=WH.ce("a");o.href="javascript:";WH.ae(o,WH.ct(WH.TERMS.newestfirst_lc));o.onclick=Listview.funcBox.coSortNewestFirst.bind(this,o);WH.ae(t,o);WH.ae(t,WH.ct(WH.TERMS.comma_punct));var n=WH.ce("a");n.href="javascript:";WH.ae(n,WH.ct(WH.TERMS.oldestfirst_lc));n.onclick=Listview.funcBox.coSortOldestFirst.bind(this,n);WH.ae(t,n);WH.ae(t,WH.ct(WH.TERMS.comma_punct));var r=WH.ce("a");r.href="javascript:";WH.ae(r,WH.ct(WH.TERMS.highestrated_lc));r.onclick=Listview.funcBox.coSortHighestRatedFirst.bind(this,r);WH.ae(t,r);var i=WH.getCookies()["comments_sort"];switch(i){case"1":o.onclick();break;case"2":n.onclick();break;default:case"3":r.onclick();break}if(!this.alternateVersions){var l=WH.ce("span");l.style.padding="0 5px";l.style.color="white";WH.ae(l,WH.ct("|"));WH.ae(t,l);var c=WH.ce("select");var m=WH.ce("option");m.value=0;m.selected="selected";WH.ae(c,m);var d={};var p={};for(var u=0,f=this.data.length;u<f;u++){if(this.data[u].dataTree!==WH.dataTree.RETAIL){p[this.data[u].dataTree]=true;continue}var h=WH.Wow.getPatchVersionObject(new Date(this.data[u].date).getTime());if(h){d[h.build]=h}}var H=[];for(var W in d){H.push(W)}H.sort((function(e,t){return t-e}));for(var g in p){if(!p.hasOwnProperty(g)){continue}var m=WH.ce("option");m.value="-"+g;WH.ae(m,WH.ct(WH.TERMS[WH.getDataTreeTerm(g)]));WH.ae(c,m)}for(var v=0,T=H.length;v<T;v++){var m=WH.ce("option");m.value=d[H[v]].timestamp;WH.ae(m,WH.ct(d[H[v]].version));WH.ae(c,m)}c.onchange=Listview.funcBox.coFilterByPatchVersion.bind(this,c);WH.ae(t,WH.ct(WH.TERMS.filterbypatch_colon));WH.ae(t,c)}WH.ae(e,t);if(this.template.userCanLock()){WH.ae(e,this.template.createLockButton())}if(this.tabClick){$("a, select",t).click(this.tabClick)}},createLockButton:function(){let e=WH.Page.commentsLocked()?WH.term("unlock"):WH.term("lock");let t=WH.Page.commentsLocked()?this.onUnlockComments:this.onLockComments;let a=WH.ce("button",{className:"btn btn-small btn-default fa fa-"+(WH.Page.commentsLocked()?"unlock":"lock"),type:"submit"},WH.ct(e));let s=t.bind(a);WH.aE(a,"click",s);return a},onLockComments:function(){let e=prompt("Enter a number of days to LOCK comments for this entity.  Enter 0 for no end time.",30);if(e===null||e===undefined){return}if(e===""){alert("You must enter a value.");return}e=parseInt(e);if(isNaN(e)||e<0){alert("You must enter a number >= 0.");return}let t=this;t.dataset.loading=true;WH.fetch(WH.Url.generatePath("/comment/entity-lock"),{method:"post",json:{type:WH.Page.getType(),id:WH.Page.getId(),days:e},complete:function(e){if(e.success){location.reload()}else{alert("Oops!  Something went wrong while locking comments:\n"+(e.error||"An internal error occurred."));t.dataset.loading=false}}})},onUnlockComments:function(){if(!confirm("Are you sure you want to UNLOCK comments for this entity?")){return}let e=this;e.dataset.loading=true;WH.fetch(WH.Url.generatePath("/comment/entity-unlock"),{method:"post",json:{type:WH.Page.getType(),id:WH.Page.getId()},complete:function(t){if(t.success){location.reload()}else{alert("Oops!  Something went wrong while unlocking comments:\n"+(t.error||"An internal error occurred."));e.dataset.loading=false}}})},onNoData:function(e){if(!this.template.commentingAvailable()){e.style.padding="1.5em 0";WH.ee(e);WH.st(e,WH.term("ugcLocked_format",WH.term("comments"),WH.Types.getLowerSingular(WH.Page.getType())));return}var t="<b>"+WH.TERMS.nocomments_tip+'</b><div class="pad2"></div>';if(g_user.id>0){var a=WH.TERMS.commentfirst_tip;a=a.replace("<a>",'<a href="javascript:" onclick="co_addYourComment()" onmousedown="return false">');t+=a}else{t+=WH.term("commentlogin_tip",'<a href="'+WH.Url.getLoginPath(location.pathname+location.search+location.hash)+'">',"</a>",'<a href="'+WH.Url.getRegistrationPath()+'">',"</a>")}e.style.padding="1.5em 0";e.innerHTML=t;if(this.template.userCanLock()){WH.ae(e,WH.ce("br"));WH.ae(e,this.template.createLockButton())}},onBeforeCreate:function(){let e=location.hash.match(/:id=([0-9]+)/);if(e){let t=WH.getCookies()["comments_sort"];switch(t){case"1":this.setSort([-5,4,-1,-2],false,false);break;case"2":this.setSort([-5,4,1,2],false,false);break;default:case"3":this.setSort([-5,4,-3,2],false,false);break}let a=parseInt(e[1]);let s=this.data.findIndex((e=>e.id===a));this.rowOffset=this.getRowOffset(s);return this.data[s]}},onAfterCreate:function(e){if(e!=null){var t=e.__div;this.tabs.__st=t}},commentingAvailable:function(){return!WH.Page.commentsLocked()||this.userCanLock()},userCanLock:function(){return WH.User.hasRole(U_GROUP_ADMIN)}};